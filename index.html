<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reborn 对话练习</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 基础样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: #F6F1E4;
            color: #333;
            font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }
        
        /* 波纹背景效果 */
        .ripple-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
        }
        
        .ripple {
            position: absolute;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(139, 195, 229, 0.15) 0%, rgba(139, 195, 229, 0) 70%);
            transform: scale(0);
            animation: ripple-animation 6s infinite;
            opacity: 0;
        }
        
        @keyframes ripple-animation {
            0% {
                transform: scale(0);
                opacity: 0.8;
            }
            50% {
                opacity: 0.4;
            }
            100% {
                transform: scale(4);
                opacity: 0;
            }
        }
        
        /* 容器样式 */
        .container {
            max-width: 1000px;
            width: 90%;
            margin: 0 auto;
            padding: 30px 20px;
            position: relative;
            z-index: 1;
        }
        
        /* 标题区域 */
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 40px 30px;
            background: linear-gradient(135deg, rgba(139, 195, 229, 0.08) 0%, rgba(64, 155, 216, 0.08) 100%);
            border-radius: 20px;
            box-shadow: 0 5px 15px rgba(139, 195, 229, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }
        
        .title {
            font-size: 3.2rem;
            font-weight: 700;
            color: #409BD8;
            letter-spacing: 1px;
            margin-bottom: 15px;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
        }
        
        .subtitle {
            font-size: 1.8rem;
            font-weight: 300;
            color: #409BD8;
            letter-spacing: 3px;
            margin-top: 10px;
            font-family: 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            opacity: 0.9;
        }
        
        /* 卡片样式 */
        .card {
            background-color: rgba(255, 255, 255, 0.85);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(139, 195, 229, 0.15);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        /* 老师功能区 */
        .teacher-section {
            margin-bottom: 40px;
        }
        
        .teacher-buttons {
            display: flex;
            gap: 20px;
            margin-top: 30px;
            margin-bottom: 30px;
        }
        
        .btn-teacher {
            background-color: #E6642A;
            color: white;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border: none;
        }
        
        .btn-teacher:hover {
            background-color: #d3541f;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(230, 100, 42, 0.3);
        }
        
        /* 学生页面区域 */
        .student-page-container {
            margin-top: 30px;
        }
        
        .student-page-box {
            background-color: rgba(139, 195, 229, 0.1);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #8BC3E5;
        }
        
        .student-page-title {
            font-size: 1.2rem;
            color: #409BD8;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .student-page-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-start;
            margin-top: 20px;
        }
        
        .btn-open-student {
            background-color: #409BD8;
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            border: none;
        }
        
        .btn-open-student:hover {
            background-color: #3281b9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(64, 155, 216, 0.3);
        }
        
        /* 导入区域 */
        .import-section {
            margin-bottom: 40px;
        }
        
        .section-title {
            font-size: 1.5rem;
            color: #409BD8;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            color: #E6642A;
        }
        
        .import-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .import-option {
            background-color: rgba(139, 195, 229, 0.1);
            border: 2px dashed #8BC3E5;
            border-radius: 15px;
            padding: 25px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .import-option:hover {
            background-color: rgba(139, 195, 229, 0.2);
            border-color: #409BD8;
            transform: translateY(-5px);
        }
        
        .import-icon {
            font-size: 2.5rem;
            color: #409BD8;
            margin-bottom: 15px;
        }
        
        .import-text {
            font-size: 1.1rem;
            color: #333;
            margin-bottom: 10px;
        }
        
        .import-note {
            font-size: 0.9rem;
            color: #666;
        }
        
        .file-input {
            display: none;
        }
        
        .import-status {
            margin-top: 20px;
            padding: 15px;
            background-color: rgba(139, 195, 229, 0.1);
            border-radius: 10px;
            text-align: center;
        }
        
        .import-status-title {
            font-size: 1.1rem;
            color: #409BD8;
            margin-bottom: 5px;
        }
        
        .import-status-count {
            font-size: 1.5rem;
            font-weight: bold;
            color: #409BD8;
        }
        
        /* 听辨区域 */
        .dictation-section {
            margin-bottom: 40px;
        }
        
        .progress-container {
            margin-bottom: 30px;
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .progress-info {
            display: flex;
            gap: 20px;
        }
        
        .progress-info-item {
            display: flex;
            flex-direction: column;
        }
        
        .progress-label {
            font-size: 0.9rem;
            color: #666;
        }
        
        .progress-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: #409BD8;
        }
        
        .progress-bar {
            height: 10px;
            background-color: rgba(139, 195, 229, 0.3);
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #409BD8;
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 5px;
        }
        
        /* 对话角色显示区域 */
        .character-display {
            background: linear-gradient(135deg, rgba(139, 195, 229, 0.1) 0%, rgba(64, 155, 216, 0.1) 100%);
            border-radius: 15px;
            padding: 40px 30px;
            text-align: center;
            margin-bottom: 30px;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }
        
        .character-display::before {
            content: '';
            position: absolute;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(139, 195, 229, 0.3) 0%, rgba(139, 195, 229, 0) 70%);
            top: -100px;
            right: -100px;
            animation: pulse 8s infinite alternate;
        }
        
        @keyframes pulse {
            0% { transform: scale(0.8); opacity: 0.3; }
            100% { transform: scale(1.2); opacity: 0.1; }
        }
        
        .character-container {
            position: relative;
            width: 100%;
            margin-bottom: 30px;
        }
        
        .character-placeholder {
            font-size: 2.5rem;
            color: #409BD8;
            margin-bottom: 15px;
            line-height: 1.3;
        }
        
        .character-smiley {
            font-size: 4rem;
            color: #E6642A;
            margin-bottom: 30px;
        }
        
        .current-question {
            font-size: 1.8rem;
            font-weight: 400;
            color: #0201D2;
            margin-bottom: 15px;
            line-height: 1.5;
            max-width: 90%;
        }
        
        .instruction-text {
            color: #E6642A;
            font-size: 1.1rem;
            margin-top: 15px;
            font-weight: 600;
        }
        
        .timer {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: rgba(230, 100, 42, 0.1);
            color: #E6642A;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* 计时器显示区域 */
        .timer-display-section {
            margin-bottom: 30px;
            text-align: center;
        }
        
        .timer-display-label {
            display: block;
            margin-bottom: 15px;
            font-size: 1.2rem;
            color: #409BD8;
            font-weight: 500;
        }
        
        .timer-display {
            width: 100%;
            padding: 25px;
            border: 3px solid #8BC3E5;
            border-radius: 15px;
            font-size: 3rem;
            color: #E6642A;
            background-color: rgba(255, 255, 255, 0.7);
            text-align: center;
            font-weight: bold;
            letter-spacing: 2px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .timer-display.active {
            border-color: #E6642A;
            box-shadow: 0 0 20px rgba(230, 100, 42, 0.3);
            animation: pulse-timer 1s infinite alternate;
        }
        
        @keyframes pulse-timer {
            0% { transform: scale(1); }
            100% { transform: scale(1.05); }
        }
        
        /* 完成消息 */
        .completion-message {
            text-align: center;
            margin-top: 40px;
            padding: 30px;
            background: linear-gradient(135deg, rgba(139, 195, 229, 0.15) 0%, rgba(64, 155, 216, 0.15) 100%);
            border-radius: 15px;
            border: 2px solid #409BD8;
            display: none;
            animation: fadeIn 0.8s ease;
        }
        
        .completion-text {
            font-size: 2.5rem;
            font-weight: 700;
            color: #E6642A;
            line-height: 1.4;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
        }
        
        .sub-completion-text {
            font-size: 1.2rem;
            color: #409BD8;
            margin-top: 10px;
            font-weight: 300;
        }
        
        /* 按钮区域 */
        .buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .btn {
            padding: 18px 25px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }
        
        .btn-primary {
            background-color: #409BD8;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #3281b9;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(64, 155, 216, 0.3);
        }
        
        .btn-secondary {
            background-color: #8BC3E5;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #72aed4;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(139, 195, 229, 0.3);
        }
        
        .btn-accent {
            background-color: #E6642A;
            color: white;
        }
        
        .btn-accent:hover {
            background-color: #d3541f;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(230, 100, 42, 0.3);
        }
        
        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* 结果区域 */
        .result-container {
            display: none;
            margin-top: 40px;
            animation: fadeIn 0.8s ease;
        }
        
        .result-title {
            font-size: 2.2rem;
            color: #409BD8;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .result-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .stat-box {
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 8px 20px rgba(139, 195, 229, 0.15);
            border: 1px solid rgba(139, 195, 229, 0.3);
        }
        
        .stat-value {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .total-sentences .stat-value {
            color: #409BD8;
        }
        
        .completed-sentences .stat-value {
            color: #8BC3E5;
        }
        
        .skipped-sentences .stat-value {
            color: #E6642A;
        }
        
        .stat-label {
            font-size: 1.1rem;
            color: #666;
        }
        
        .result-details {
            margin-top: 40px;
        }
        
        .result-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 40px;
        }
        
        /* 句子列表 */
        .sentence-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }
        
        .sentence-item {
            padding: 15px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .sentence-completed {
            background-color: rgba(139, 195, 229, 0.15);
            border-left: 5px solid #409BD8;
        }
        
        .sentence-skipped {
            background-color: rgba(230, 100, 42, 0.1);
            border-left: 5px solid #E6642A;
        }
        
        .sentence-text {
            font-size: 1.1rem;
            font-weight: 600;
            line-height: 1.4;
        }
        
        .sentence-meaning {
            font-size: 0.9rem;
            color: #666;
            font-style: italic;
        }
        
        .sentence-status {
            font-size: 0.9rem;
            padding: 3px 10px;
            border-radius: 20px;
            align-self: flex-start;
        }
        
        .status-completed {
            background-color: rgba(64, 155, 216, 0.2);
            color: #409BD8;
        }
        
        .status-skipped {
            background-color: rgba(230, 100, 42, 0.2);
            color: #E6642A;
        }
        
        /* 页脚 */
        .footer {
            text-align: center;
            margin-top: 60px;
            padding-top: 30px;
            border-top: 1px solid rgba(139, 195, 229, 0.3);
            color: #8BC3E5;
            font-size: 0.9rem;
        }
        
        /* 模态框样式 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 20px;
            padding: 40px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            animation: modalAppear 0.3s ease;
        }
        
        @keyframes modalAppear {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-title {
            font-size: 1.8rem;
            color: #E6642A;
            margin-bottom: 25px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .modal-input {
            width: 100%;
            padding: 18px 20px;
            border: 2px solid #E6642A;
            border-radius: 12px;
            font-size: 1.2rem;
            color: #333;
            background-color: rgba(230, 100, 42, 0.05);
            margin-bottom: 25px;
            transition: all 0.3s ease;
        }
        
        .modal-input:focus {
            outline: none;
            border-color: #d3541f;
            box-shadow: 0 0 0 3px rgba(230, 100, 42, 0.2);
        }
        
        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        /* 学生模式样式 */
        .student-mode .import-section,
        .student-mode .teacher-section {
            display: none;
        }
        
        .student-mode .header {
            background: linear-gradient(135deg, rgba(230, 100, 42, 0.08) 0%, rgba(230, 100, 42, 0.08) 100%);
            border: 1px solid rgba(230, 100, 42, 0.6);
        }
        
        .student-mode .title {
            color: #E6642A;
        }
        
        .student-mode .subtitle {
            color: #E6642A;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .container {
                width: 95%;
                padding: 20px 15px;
            }
            
            .header {
                padding: 30px 20px;
            }
            
            .title {
                font-size: 2.5rem;
            }
            
            .subtitle {
                font-size: 1.5rem;
                letter-spacing: 3px;
            }
            
            .current-question {
                font-size: 1.5rem;
            }
            
            .character-placeholder {
                font-size: 2rem;
            }
            
            .character-smiley {
                font-size: 3rem;
            }
            
            .completion-text {
                font-size: 2rem;
            }
            
            .timer-display {
                font-size: 2.5rem;
            }
            
            .buttons {
                grid-template-columns: 1fr;
            }
            
            .result-stats {
                grid-template-columns: 1fr 1fr;
            }
            
            .teacher-buttons {
                flex-direction: column;
            }
            
            .modal-content {
                padding: 30px 20px;
            }
            
            .student-page-actions {
                flex-direction: column;
            }
        }
        
        @media (max-width: 480px) {
            .header {
                padding: 25px 15px;
            }
            
            .title {
                font-size: 2.2rem;
            }
            
            .subtitle {
                font-size: 1.2rem;
                letter-spacing: 2px;
            }
            
            .current-question {
                font-size: 1.2rem;
            }
            
            .character-placeholder {
                font-size: 1.8rem;
            }
            
            .character-smiley {
                font-size: 2.5rem;
            }
            
            .completion-text {
                font-size: 1.8rem;
            }
            
            .timer-display {
                font-size: 2rem;
            }
            
            .result-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- 波纹背景 -->
    <div class="ripple-container" id="ripple-container"></div>
    
    <!-- 口令输入模态框 -->
    <div class="modal-overlay" id="password-modal">
        <div class="modal-content">
            <h2 class="modal-title"><i class="fas fa-lock"></i> 今日口令</h2>
            <p style="text-align: center; color: #666; margin-bottom: 20px;">请输入老师提供的今日口令以开始对话练习</p>
            <input type="password" id="password-input" class="modal-input" placeholder="请输入今日口令">
            <div class="modal-buttons">
                <button id="password-submit" class="btn btn-accent">
                    <i class="fas fa-check"></i> 确认
                </button>
                <button id="password-cancel" class="btn btn-secondary">
                    <i class="fas fa-times"></i> 取消
                </button>
            </div>
        </div>
    </div>
    
    <div class="container" id="main-container">
        <!-- 标题区域 -->
        <header class="header">
            <h1 class="title">Reborn 对话练习</h1>
            <p class="subtitle">天天进步，每日新生</p>
        </header>
        
        <!-- 老师功能区 -->
        <section class="teacher-section card" id="teacher-section">
            <h2 class="section-title"><i class="fas fa-chalkboard-teacher"></i> 老师功能区</h2>
            <p style="margin-bottom: 20px; color: #666;">作为老师，您可以导入对话、设置今日口令，并直接打开学生练习页面。</p>
            
            <div class="teacher-buttons">
                <button id="set-password-btn" class="btn-teacher">
                    <i class="fas fa-key"></i> 设置今日口令
                </button>
                <button id="open-student-page" class="btn-teacher">
                    <i class="fas fa-user-graduate"></i> 打开学生练习页面
                </button>
            </div>
            
            <!-- 学生页面区域 -->
            <div class="student-page-container" id="student-page-container">
                <div class="student-page-box">
                    <h3 class="student-page-title"><i class="fas fa-chalkboard"></i> 学生练习页面</h3>
                    <p style="color: #666; margin-bottom: 15px; font-size: 0.95rem;">点击下方按钮直接打开学生练习页面。如果设置了今日口令，学生需要输入正确口令才能开始练习。</p>
                    
                    <div class="student-page-actions">
                        <button id="open-student-window" class="btn-open-student">
                            <i class="fas fa-external-link-alt"></i> 在新窗口打开学生页面
                        </button>
                    </div>
                    
                    <div style="margin-top: 15px; font-size: 0.9rem; color: #666;">
                        <p><i class="fas fa-info-circle"></i> 提示：学生页面会自动加载当前选中的对话，并隐藏老师功能区和导入区域。</p>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- 导入区域 -->
        <section class="import-section card">
            <h2 class="section-title"><i class="fas fa-file-import"></i> 导入对话</h2>
            <p style="margin-bottom: 20px; color: #666;">导入您的对话文件，系统将自动提取英文对话并打乱播放。支持 TXT、Word 和 Excel 格式。</p>
            
            <div class="import-options">
                <div class="import-option" onclick="document.getElementById('txt-file').click()">
                    <div class="import-icon"><i class="fas fa-file-alt"></i></div>
                    <div class="import-text">TXT 文件</div>
                    <div class="import-note">每行一个对话</div>
                    <input type="file" id="txt-file" class="file-input" accept=".txt" onchange="handleFileImport(event, 'txt')">
                </div>
                
                <div class="import-option" onclick="document.getElementById('word-file').click()">
                    <div class="import-icon"><i class="fas fa-file-word"></i></div>
                    <div class="import-text">Word 文件</div>
                    <div class="import-note">.doc 或 .docx</div>
                    <input type="file" id="word-file" class="file-input" accept=".doc,.docx" onchange="handleFileImport(event, 'word')">
                </div>
                
                <div class="import-option" onclick="document.getElementById('excel-file').click()">
                    <div class="import-icon"><i class="fas fa-file-excel"></i></div>
                    <div class="import-text">Excel 文件</div>
                    <div class="import-note">.xls 或 .xlsx</div>
                    <input type="file" id="excel-file" class="file-input" accept=".xls,.xlsx" onchange="handleFileImport(event, 'excel')">
                </div>
            </div>
            
            <div id="import-status" style="display: none;">
                <div class="import-status">
                    <div class="import-status-title">已导入对话</div>
                    <div class="import-status-count" id="sentence-count">0</div>
                    <div style="font-size: 0.9rem; color: #666; margin-top: 5px;">个对话</div>
                </div>
            </div>
        </section>
        
        <!-- 对话练习区域 -->
        <section class="dictation-section card">
            <h2 class="section-title"><i class="fas fa-headphones"></i> 对话练习</h2>
            
            <div class="progress-container">
                <div class="progress-header">
                    <div class="progress-info">
                        <div class="progress-info-item">
                            <span class="progress-label">当前进度</span>
                            <span class="progress-value" id="current-count">0/0</span>
                        </div>
                        <div class="progress-info-item">
                            <span class="progress-label">完成数量</span>
                            <span class="progress-value" id="completed-count">0</span>
                        </div>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
            </div>
            
            <div class="character-display">
                <div class="timer" id="timer">
                    <i class="fas fa-clock"></i> <span id="timer-value">准备</span>
                </div>
                <div class="character-container">
                    <div class="character-placeholder">此处应当有人</div>
                    <div class="character-smiley">^_^</div>
                </div>
                <div class="current-question" id="current-sentence-display">准备开始对话练习</div>
                <div class="instruction-text" id="hint-text">导入对话后点击"开始练习"按钮</div>
            </div>
            
            <div class="timer-display-section">
                <label class="timer-display-label">Listen and Answer the Questions</label>
                <div class="timer-display" id="timer-display">00:45</div>
            </div>
            
            <!-- 完成消息 -->
            <div class="completion-message" id="completion-message">
                <div class="completion-text">Well done!</div>
                <div class="completion-text">Practice makes perfect</div>
                <div class="sub-completion-text">对话练习已完成</div>
            </div>
            
            <div class="buttons">
                <button id="start-btn" class="btn btn-primary">
                    <i class="fas fa-play-circle"></i> 开始练习
                </button>
                <button id="repeat-btn" class="btn btn-secondary" disabled>
                    <i class="fas fa-redo"></i> 重复对话
                </button>
                <button id="skip-btn" class="btn btn-accent" disabled>
                    <i class="fas fa-forward"></i> 跳过
                </button>
            </div>
        </section>
        
        <!-- 结果区域 -->
        <div class="result-container card" id="result-container">
            <h2 class="result-title">练习完成!</h2>
            
            <div class="result-stats">
                <div class="stat-box total-sentences">
                    <div class="stat-value" id="total-sentences">0</div>
                    <div class="stat-label">总对话数</div>
                </div>
                
                <div class="stat-box completed-sentences">
                    <div class="stat-value" id="completed-sentences">0</div>
                    <div class="stat-label">完成数量</div>
                </div>
                
                <div class="stat-box skipped-sentences">
                    <div class="stat-value" id="skipped-sentences">0</div>
                    <div class="stat-label">跳过数量</div>
                </div>
            </div>
            
            <div class="result-details">
                <h3 class="section-title"><i class="fas fa-list"></i> 详细结果</h3>
                <div class="sentence-list" id="sentence-list">
                    <!-- 对话结果将在这里显示 -->
                </div>
            </div>
            
            <div class="result-buttons">
                <button id="restart-btn" class="btn btn-primary">
                    <i class="fas fa-sync-alt"></i> 重新练习
                </button>
                <button id="export-btn" class="btn btn-secondary">
                    <i class="fas fa-download"></i> 导出结果 (Excel)
                </button>
            </div>
        </div>
        
        <!-- 页脚 -->
        <footer class="footer">
            <p>Reborn 对话练习 | 天天进步，每日新生</p>
        </footer>
    </div>

    <!-- 处理Excel文件的库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        // 应用状态
        const state = {
            sentences: [],       // 所有对话对象 [{english: "", meaning: ""}, ...]
            currentIndex: 0,     // 当前对话索引
            completedCount: 0,   // 完成数量
            isActive: false,     // 是否正在进行练习
            currentSentence: null, // 当前对话对象
            results: [],         // 结果记录
            timer: null,         // 计时器
            countdownTimer: null, // 倒计时计时器
            timeLeft: 45,        // 倒计时剩余时间（45秒）
            skippedSentences: 0, // 跳过数量
            importedSentencesCount: 0, // 导入的对话数量
            selectedSentences: [], // 为学生选择的对话
            isStudentMode: false,// 是否是学生模式
            todayPassword: "",   // 今日口令
            passwordSet: false,  // 是否设置了口令
            studentWindow: null, // 学生窗口引用
            isPlaying: false,    // 是否正在朗读
            isCountdownActive: false // 倒计时是否进行中
        };
        
        // DOM元素
        const elements = {
            startBtn: document.getElementById('start-btn'),
            repeatBtn: document.getElementById('repeat-btn'),
            skipBtn: document.getElementById('skip-btn'),
            currentSentenceDisplay: document.getElementById('current-sentence-display'),
            hintText: document.getElementById('hint-text'),
            currentCount: document.getElementById('current-count'),
            completedCount: document.getElementById('completed-count'),
            progressFill: document.getElementById('progress-fill'),
            resultContainer: document.getElementById('result-container'),
            totalSentences: document.getElementById('total-sentences'),
            completedSentences: document.getElementById('completed-sentences'),
            skippedSentences: document.getElementById('skipped-sentences'),
            sentenceList: document.getElementById('sentence-list'),
            restartBtn: document.getElementById('restart-btn'),
            exportBtn: document.getElementById('export-btn'),
            timerValue: document.getElementById('timer-value'),
            importStatus: document.getElementById('import-status'),
            sentenceCount: document.getElementById('sentence-count'),
            setPasswordBtn: document.getElementById('set-password-btn'),
            openStudentPageBtn: document.getElementById('open-student-page'),
            openStudentWindowBtn: document.getElementById('open-student-window'),
            passwordModal: document.getElementById('password-modal'),
            passwordInput: document.getElementById('password-input'),
            passwordSubmit: document.getElementById('password-submit'),
            passwordCancel: document.getElementById('password-cancel'),
            mainContainer: document.getElementById('main-container'),
            teacherSection: document.getElementById('teacher-section'),
            studentPageContainer: document.getElementById('student-page-container'),
            timerDisplay: document.getElementById('timer-display'),
            completionMessage: document.getElementById('completion-message')
        };
        
        // 检查URL参数，判断是否是学生模式
        function checkUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const isStudent = urlParams.get('student') === 'true';
            const password = urlParams.get('password');
            
            if (isStudent) {
                // 学生模式
                state.isStudentMode = true;
                document.body.classList.add('student-mode');
                
                // 尝试从URL获取对话数据
                const sentencesData = urlParams.get('sentences');
                if (sentencesData) {
                    try {
                        state.selectedSentences = JSON.parse(decodeURIComponent(sentencesData));
                        state.sentences = state.selectedSentences;
                        state.importedSentencesCount = state.sentences.length;
                        
                        // 更新UI
                        elements.hintText.textContent = `已加载 ${state.sentences.length} 个对话，点击"开始练习"按钮`;
                        elements.startBtn.disabled = false;
                    } catch (e) {
                        console.error('解析对话数据失败:', e);
                        elements.hintText.textContent = "加载对话失败，请联系老师";
                    }
                }
                
                // 检查是否需要密码
                state.todayPassword = localStorage.getItem('todayPassword') || "";
                if (state.todayPassword) {
                    // 有设置密码，直接弹出密码输入框
                    setTimeout(() => {
                        showPasswordModal();
                    }, 500);
                } else {
                    // 没有设置密码，直接进入学生模式
                    startStudentMode();
                }
            } else {
                // 老师模式
                state.isStudentMode = false;
                elements.hintText.textContent = "请先导入对话文件";
            }
        }
        
        // 开始学生模式
        function startStudentMode() {
            // 隐藏老师功能区和导入区域
            if (elements.teacherSection) {
                elements.teacherSection.style.display = 'none';
            }
            
            // 更新提示
            elements.hintText.textContent = `已加载 ${state.sentences.length} 个对话，点击"开始练习"按钮`;
            
            // 如果已有对话，启用开始按钮
            if (state.sentences.length > 0) {
                elements.startBtn.disabled = false;
            }
        }
        
        // 显示口令输入模态框
        function showPasswordModal() {
            elements.passwordModal.style.display = 'flex';
            elements.passwordInput.focus();
        }
        
        // 隐藏口令输入模态框
        function hidePasswordModal() {
            elements.passwordModal.style.display = 'none';
            elements.passwordInput.value = '';
        }
        
        // 初始化
        function init() {
            // 创建波纹背景
            createRipples();
            
            // 检查URL参数
            checkUrlParams();
            
            // 事件监听器
            elements.startBtn.addEventListener('click', startExercise);
            elements.repeatBtn.addEventListener('click', repeatSentence);
            elements.skipBtn.addEventListener('click', skipSentence);
            elements.restartBtn.addEventListener('click', restartExercise);
            elements.exportBtn.addEventListener('click', exportResults);
            
            // 老师功能按钮
            elements.setPasswordBtn.addEventListener('click', setPassword);
            elements.openStudentPageBtn.addEventListener('click', openStudentPage);
            elements.openStudentWindowBtn.addEventListener('click', openStudentWindow);
            
            // 口令模态框按钮
            elements.passwordSubmit.addEventListener('click', verifyPassword);
            elements.passwordCancel.addEventListener('click', hidePasswordModal);
            
            // 按Enter键提交口令
            elements.passwordInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    verifyPassword();
                }
            });
            
            // 如果没有在学生模式，显示正常提示
            if (!state.isStudentMode) {
                elements.hintText.textContent = "请先导入对话文件";
            }
        }
        
        // 创建波纹背景效果
        function createRipples() {
            const container = document.getElementById('ripple-container');
            const colors = ['rgba(139, 195, 229, 0.15)', 'rgba(64, 155, 216, 0.1)', 'rgba(230, 100, 42, 0.05)', 'rgba(2, 1, 210, 0.05)'];
            
            // 创建多个波纹
            for (let i = 0; i < 5; i++) {
                const ripple = document.createElement('div');
                ripple.className = 'ripple';
                
                // 随机位置和大小
                const size = Math.random() * 300 + 100;
                const left = Math.random() * 100;
                const top = Math.random() * 100;
                const color = colors[Math.floor(Math.random() * colors.length)];
                const delay = Math.random() * 5;
                
                ripple.style.width = `${size}px`;
                ripple.style.height = `${size}px`;
                ripple.style.left = `${left}%`;
                ripple.style.top = `${top}%`;
                ripple.style.background = `radial-gradient(circle, ${color} 0%, rgba(139, 195, 229, 0) 70%)`;
                ripple.style.animationDelay = `${delay}s`;
                
                container.appendChild(ripple);
            }
        }
        
        // 从文本中提取英文对话（每行一个）
        function extractSentences(text) {
            const lines = text.split('\n');
            const sentences = [];
            
            for (const line of lines) {
                // 移除行首尾空格
                const trimmedLine = line.trim();
                
                // 如果为空行，跳过
                if (!trimmedLine) continue;
                
                // 提取英文对话（允许各种标点符号）
                const englishRegex = /^[a-zA-Z0-9\s\-\',\.\(\)\!\?;:"']+$/;
                
                if (englishRegex.test(trimmedLine) && trimmedLine.length > 5) {
                    // 如果整行都是英文且长度合理，作为对话
                    sentences.push({
                        english: trimmedLine,
                        meaning: ""
                    });
                } else {
                    // 尝试提取英文部分
                    const englishMatch = trimmedLine.match(/[a-zA-Z][a-zA-Z0-9\s\-\',\.\(\)\!\?;:"']*[\.\!\?]/);
                    
                    if (englishMatch) {
                        const english = englishMatch[0].trim();
                        if (english.length > 5) {
                            sentences.push({
                                english: english,
                                meaning: ""
                            });
                        }
                    } else {
                        // 如果没有标点结尾，也尝试提取
                        const englishMatch2 = trimmedLine.match(/[a-zA-Z][a-zA-Z0-9\s\-\',\.\(\)\!\?;:"']+/);
                        if (englishMatch2) {
                            const english = englishMatch2[0].trim();
                            if (english.length > 5) {
                                sentences.push({
                                    english: english,
                                    meaning: ""
                                });
                            }
                        }
                    }
                }
            }
            
            return sentences;
        }
        
        // 处理文件导入
        function handleFileImport(event, fileType) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const content = e.target.result;
                let sentences = [];
                
                try {
                    switch(fileType) {
                        case 'txt':
                            // 对于TXT文件，每行一个对话
                            sentences = extractSentences(content);
                            break;
                            
                        case 'word':
                            // Word文件也按文本处理
                            sentences = extractSentences(content);
                            break;
                            
                        case 'excel':
                            // 使用SheetJS库解析Excel文件
                            const workbook = XLSX.read(content, {type: 'binary'});
                            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                            const data = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                            
                            // 将Excel数据转换为文本行
                            const excelText = data
                                .map(row => Array.isArray(row) ? row.join(' ') : String(row))
                                .join('\n');
                            
                            sentences = extractSentences(excelText);
                            break;
                    }
                    
                    // 过滤空值
                    state.sentences = sentences.filter(item => item.english && item.english.trim() !== '');
                    state.importedSentencesCount = state.sentences.length;
                    
                    if (state.sentences.length === 0) {
                        showFeedback('未找到英文对话，请检查文件内容', 'error');
                        return;
                    }
                    
                    // 显示导入状态
                    elements.importStatus.style.display = 'block';
                    elements.sentenceCount.textContent = state.sentences.length;
                    
                    // 显示成功消息
                    showFeedback(`成功导入 ${state.sentences.length} 个对话`, 'success');
                    
                    // 更新提示
                    elements.hintText.textContent = `已导入 ${state.sentences.length} 个对话，点击"开始练习"按钮`;
                    
                    // 启用开始按钮
                    elements.startBtn.disabled = false;
                    
                } catch (error) {
                    console.error('文件解析错误:', error);
                    showFeedback('文件解析失败，请检查文件格式', 'error');
                }
            };
            
            // 根据文件类型读取
            if (fileType === 'excel') {
                reader.readAsBinaryString(file);
            } else {
                reader.readAsText(file);
            }
        }
        
        // 开始练习
        function startExercise() {
            if (state.sentences.length === 0) {
                showFeedback('请先导入对话', 'error');
                return;
            }
            
            // 重置状态
            state.isActive = true;
            state.currentIndex = 0;
            state.completedCount = 0;
            state.results = [];
            state.skippedSentences = 0;
            
            // 确定要使用的对话数量
            let sentencesToUse = [...state.sentences];
            
            // 如果是学生模式，使用已加载的对话
            // 如果是老师模式，如果超过20个对话，随机选择20个
            if (!state.isStudentMode && sentencesToUse.length > 20) {
                // 如果超过20个对话，随机选择20个
                sentencesToUse = shuffleArray(sentencesToUse).slice(0, 20);
                state.selectedSentences = sentencesToUse; // 保存为学生准备的对话
            } else {
                state.selectedSentences = sentencesToUse;
            }
            
            // 打乱对话顺序
            state.sentences = shuffleArray(sentencesToUse);
            
            // 启用控件
            elements.repeatBtn.disabled = false;
            elements.skipBtn.disabled = false;
            
            // 禁用开始按钮
            elements.startBtn.disabled = true;
            elements.startBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 练习进行中';
            
            // 隐藏结果和完成消息
            elements.resultContainer.style.display = 'none';
            elements.completionMessage.style.display = 'none';
            
            // 重置计时器显示
            elements.timerDisplay.textContent = "00:45";
            elements.timerDisplay.classList.remove('active');
            
            // 开始第一个对话
            nextSentence();
        }
        
        // 打乱数组
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }
        
        // 获取下一个对话
        function nextSentence() {
            // 清除之前的计时器
            clearInterval(state.timer);
            clearInterval(state.countdownTimer);
            state.isCountdownActive = false;
            
            if (state.currentIndex >= state.sentences.length) {
                endExercise();
                return;
            }
            
            // 获取当前对话对象
            state.currentSentence = state.sentences[state.currentIndex];
            state.currentIndex++;
            
            // 更新显示
            elements.currentSentenceDisplay.textContent = `对话 ${state.currentIndex}/${state.sentences.length}`;
            elements.hintText.textContent = "正在朗读对话...";
            elements.timerValue.textContent = "准备中";
            elements.timerDisplay.textContent = "00:45";
            elements.timerDisplay.classList.remove('active');
            
            // 朗读对话
            speakSentence(state.currentSentence.english);
            
            // 更新进度
            updateProgress();
        }
        
        // 朗读对话 - 使用自然语速
        function speakSentence(sentence) {
            if (!window.speechSynthesis) {
                alert("您的浏览器不支持语音合成功能，请使用Chrome或Edge浏览器");
                return;
            }
            
            // 停止任何正在进行的语音
            window.speechSynthesis.cancel();
            
            // 确保sentence是字符串
            if (typeof sentence !== 'string') {
                console.error('speakSentence: sentence不是字符串:', sentence);
                return;
            }
            
            // 创建语音
            const utterance = new SpeechSynthesisUtterance();
            utterance.text = sentence;
            utterance.lang = 'en-US';
            
            // 设置自然语速（0.8-1.2之间的正常语速）
            utterance.rate = 1.0; // 正常语速
            
            // 设置音调更自然
            utterance.pitch = 1.0;
            
            // 使用英语语音
            const voices = speechSynthesis.getVoices();
            const englishVoice = voices.find(v => v.lang.startsWith('en-') && v.name.includes('Natural'));
            if (englishVoice) {
                utterance.voice = englishVoice;
            } else {
                // 如果没有自然语音，使用第一个英语语音
                const englishVoices = voices.filter(v => v.lang.startsWith('en-'));
                if (englishVoices.length > 0) {
                    utterance.voice = englishVoices[0];
                }
            }
            
            // 设置朗读结束后的回调
            utterance.onend = function() {
                state.isPlaying = false;
                elements.hintText.textContent = "朗读完成，准备开始回答...";
                
                // 1秒后开始倒计时
                setTimeout(() => {
                    startCountdown();
                }, 1000);
            };
            
            // 开始朗读
            state.isPlaying = true;
            speechSynthesis.speak(utterance);
        }
        
        // 开始45秒倒计时
        function startCountdown() {
            clearInterval(state.countdownTimer);
            state.timeLeft = 45; // 45秒倒计时
            state.isCountdownActive = true;
            
            // 更新显示
            elements.hintText.textContent = "请回答问题";
            elements.timerValue.textContent = "倒计时";
            elements.timerDisplay.textContent = formatTime(state.timeLeft);
            elements.timerDisplay.classList.add('active');
            
            // 开始倒计时
            state.countdownTimer = setInterval(() => {
                state.timeLeft--;
                elements.timerDisplay.textContent = formatTime(state.timeLeft);
                
                if (state.timeLeft <= 0) {
                    // 时间到
                    clearInterval(state.countdownTimer);
                    state.isCountdownActive = false;
                    
                    // 记录跳过
                    state.results.push({
                        sentence: state.currentSentence.english,
                        meaning: state.currentSentence.meaning,
                        status: "skipped",
                        timeUsed: 45
                    });
                    
                    state.skippedSentences++;
                    
                    // 显示"Time is up."效果
                    elements.hintText.textContent = "Time is up.";
                    elements.timerDisplay.textContent = "00:00";
                    elements.timerDisplay.classList.remove('active');
                    
                    // 1秒后显示下一个对话
                    setTimeout(() => {
                        if (state.currentIndex <= state.sentences.length) {
                            nextSentence();
                        } else {
                            endExercise();
                        }
                    }, 1000);
                }
            }, 1000);
        }
        
        // 格式化时间显示（MM:SS）
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        // 重复对话
        function repeatSentence() {
            if (state.isActive && state.currentSentence) {
                // 停止当前倒计时
                clearInterval(state.countdownTimer);
                state.isCountdownActive = false;
                
                // 重置计时器显示
                elements.timerDisplay.textContent = "00:45";
                elements.timerDisplay.classList.remove('active');
                
                // 重新朗读对话
                speakSentence(state.currentSentence.english);
            }
        }
        
        // 跳过当前对话
        function skipSentence() {
            if (!state.isActive) return;
            
            // 停止当前倒计时
            clearInterval(state.countdownTimer);
            state.isCountdownActive = false;
            
            // 记录跳过
            state.results.push({
                sentence: state.currentSentence.english,
                meaning: state.currentSentence.meaning,
                status: "skipped",
                timeUsed: 45 - state.timeLeft
            });
            
            state.skippedSentences++;
            
            // 更新完成计数（跳过的也算完成一次练习）
            state.completedCount++;
            
            // 显示反馈
            elements.hintText.textContent = "已跳过此对话";
            elements.timerDisplay.textContent = "已跳过";
            elements.timerDisplay.classList.remove('active');
            
            // 更新进度
            updateProgress();
            
            // 延迟显示下一个对话
            setTimeout(() => {
                if (state.currentIndex <= state.sentences.length) {
                    nextSentence();
                } else {
                    endExercise();
                }
            }, 1000);
        }
        
        // 手动标记为完成（学生完成回答后）
        function markAsCompleted() {
            if (!state.isActive || !state.isCountdownActive) return;
            
            // 停止当前倒计时
            clearInterval(state.countdownTimer);
            state.isCountdownActive = false;
            
            // 记录完成
            state.results.push({
                sentence: state.currentSentence.english,
                meaning: state.currentSentence.meaning,
                status: "completed",
                timeUsed: 45 - state.timeLeft
            });
            
            state.completedCount++;
            
            // 显示反馈
            elements.hintText.textContent = "完成回答！";
            elements.timerDisplay.textContent = formatTime(state.timeLeft);
            elements.timerDisplay.classList.remove('active');
            
            // 更新进度
            updateProgress();
            
            // 延迟显示下一个对话
            setTimeout(() => {
                if (state.currentIndex <= state.sentences.length) {
                    nextSentence();
                } else {
                    endExercise();
                }
            }, 1500);
        }
        
        // 更新进度显示
        function updateProgress() {
            elements.currentCount.textContent = `${state.currentIndex}/${state.sentences.length}`;
            elements.completedCount.textContent = state.completedCount;
            
            const progressPercent = (state.currentIndex / state.sentences.length) * 100;
            elements.progressFill.style.width = `${progressPercent}%`;
        }
        
        // 结束练习
        function endExercise() {
            state.isActive = false;
            clearInterval(state.timer);
            clearInterval(state.countdownTimer);
            state.isCountdownActive = false;
            
            // 禁用控件
            elements.repeatBtn.disabled = true;
            elements.skipBtn.disabled = true;
            
            // 启用开始按钮
            elements.startBtn.disabled = false;
            elements.startBtn.innerHTML = '<i class="fas fa-play-circle"></i> 重新练习';
            
            // 显示完成消息
            elements.completionMessage.style.display = 'block';
            
            // 显示结果
            showResults();
        }
        
        // 显示结果
        function showResults() {
            const total = state.sentences.length;
            const completed = state.completedCount;
            const skipped = state.skippedSentences;
            
            // 更新统计
            elements.totalSentences.textContent = total;
            elements.completedSentences.textContent = completed;
            elements.skippedSentences.textContent = skipped;
            
            // 显示对话列表
            elements.sentenceList.innerHTML = "";
            state.results.forEach((result, index) => {
                const sentenceItem = document.createElement('div');
                
                let statusClass = '';
                let statusText = '';
                let statusLabel = '';
                
                if (result.status === "skipped") {
                    statusClass = 'sentence-skipped';
                    statusText = 'status-skipped';
                    statusLabel = '跳过';
                } else {
                    statusClass = 'sentence-completed';
                    statusText = 'status-completed';
                    statusLabel = '完成';
                }
                
                sentenceItem.className = `sentence-item ${statusClass}`;
                
                let htmlContent = `
                    <div class="sentence-text">${index + 1}. ${result.sentence}</div>
                    <div>用时: ${result.timeUsed}秒</div>
                `;
                
                // 如果有中文含义，显示在结果中
                if (result.meaning) {
                    htmlContent += `<div class="sentence-meaning">含义: ${result.meaning}</div>`;
                }
                
                htmlContent += `<div class="sentence-status ${statusText}">${statusLabel}</div>`;
                
                sentenceItem.innerHTML = htmlContent;
                elements.sentenceList.appendChild(sentenceItem);
            });
            
            // 显示结果容器
            elements.resultContainer.style.display = 'block';
            
            // 滚动到结果区域
            elements.resultContainer.scrollIntoView({ behavior: 'smooth' });
        }
        
        // 重新练习
        function restartExercise() {
            // 重置状态
            state.currentIndex = 0;
            state.completedCount = 0;
            state.isActive = false;
            state.currentSentence = null;
            state.results = [];
            clearInterval(state.timer);
            clearInterval(state.countdownTimer);
            state.timeLeft = 45;
            state.skippedSentences = 0;
            state.isCountdownActive = false;
            
            // 重置UI
            elements.currentSentenceDisplay.textContent = "准备开始对话练习";
            elements.hintText.textContent = `已导入 ${state.sentences.length} 个对话，点击"开始练习"按钮`;
            elements.resultContainer.style.display = 'none';
            elements.completionMessage.style.display = 'none';
            elements.startBtn.disabled = false;
            elements.startBtn.innerHTML = '<i class="fas fa-play-circle"></i> 开始练习';
            elements.repeatBtn.disabled = true;
            elements.skipBtn.disabled = true;
            elements.timerValue.textContent = "准备";
            elements.timerDisplay.textContent = "00:45";
            elements.timerDisplay.classList.remove('active');
            
            // 更新进度
            updateProgress();
            
            // 滚动到顶部
            document.body.scrollIntoView({ behavior: 'smooth' });
        }
        
        // 导出结果
        function exportResults() {
            if (state.results.length === 0) {
                showFeedback('没有可导出的结果', 'error');
                return;
            }
            
            try {
                // 创建数据
                const data = [
                    ['序号', '英文对话', '中文含义', '状态', '用时(秒)'],
                    ...state.results.map((result, index) => [
                        index + 1,
                        result.sentence,
                        result.meaning || "",
                        result.status === "skipped" ? "跳过" : "完成",
                        result.timeUsed
                    ]),
                    [],
                    ['统计', '数值'],
                    ['总对话数', state.sentences.length],
                    ['完成数量', state.completedCount],
                    ['跳过数量', state.skippedSentences]
                ];
                
                // 创建工作表
                const ws = XLSX.utils.aoa_to_sheet(data);
                
                // 设置列宽
                const colWidths = [
                    {wch: 8},   // 序号
                    {wch: 50},  // 英文对话
                    {wch: 30},  // 中文含义
                    {wch: 10},  // 状态
                    {wch: 10}   // 用时
                ];
                ws['!cols'] = colWidths;
                
                // 创建工作簿
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "对话练习结果");
                
                // 生成文件名
                const date = new Date();
                const fileName = `对话练习结果_${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}_${date.getHours().toString().padStart(2, '0')}${date.getMinutes().toString().padStart(2, '0')}.xlsx`;
                
                // 导出文件
                XLSX.writeFile(wb, fileName);
                
                showFeedback('结果已导出为Excel文件', 'success');
            } catch (error) {
                console.error('导出失败:', error);
                showFeedback('导出失败，请重试', 'error');
            }
        }
        
        // 设置今日口令
        function setPassword() {
            const password = prompt("请输入今日口令（学生需要此口令才能访问练习页面）：", "");
            if (password !== null && password.trim() !== "") {
                state.todayPassword = password.trim();
                localStorage.setItem('todayPassword', state.todayPassword);
                state.passwordSet = true;
                showFeedback('今日口令已设置！', 'success');
            }
        }
        
        // 打开学生页面
        function openStudentPage() {
            if (state.selectedSentences.length === 0) {
                showFeedback('请先导入对话并开始一次练习以选择对话', 'error');
                return;
            }
            
            // 创建学生页面URL
            const currentUrl = window.location.origin + window.location.pathname;
            
            // 准备URL参数
            const params = new URLSearchParams();
            params.append('student', 'true');
            
            // 如果设置了口令，添加到参数
            if (state.passwordSet && state.todayPassword) {
                params.append('password', state.todayPassword);
            }
            
            // 添加对话数据（编码为JSON）
            const sentencesJson = JSON.stringify(state.selectedSentences);
            params.append('sentences', encodeURIComponent(sentencesJson));
            
            const studentUrl = `${currentUrl}?${params.toString()}`;
            
            // 在新窗口打开学生页面
            state.studentWindow = window.open(studentUrl, '_blank', 'width=1000,height=800,scrollbars=yes');
            
            if (state.studentWindow) {
                showFeedback('学生练习页面已打开！', 'success');
            } else {
                showFeedback('无法打开新窗口，请检查浏览器设置', 'error');
            }
        }
        
        // 在新窗口打开学生页面
        function openStudentWindow() {
            openStudentPage();
        }
        
        // 验证口令
        function verifyPassword() {
            const inputPassword = elements.passwordInput.value.trim();
            
            if (inputPassword === state.todayPassword) {
                // 口令正确，隐藏模态框，开始学生模式
                hidePasswordModal();
                startStudentMode();
                showFeedback('口令正确！可以开始练习了。', 'success');
            } else {
                // 口令错误
                showFeedback('口令错误！请联系老师获取正确的今日口令。', 'error');
                elements.passwordInput.value = '';
                elements.passwordInput.focus();
            }
        }
        
        // 显示反馈消息
        function showFeedback(message, type) {
            // 这里可以添加反馈显示逻辑，为了简化，使用alert
            if (type === 'error') {
                alert("错误: " + message);
            } else if (type === 'success') {
                // 可以添加更美观的反馈显示
                console.log("成功: " + message);
            }
        }
        
        // 为计时器显示添加点击事件，用于标记完成
        elements.timerDisplay.addEventListener('click', function() {
            if (state.isActive && state.isCountdownActive) {
                markAsCompleted();
            }
        });
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>